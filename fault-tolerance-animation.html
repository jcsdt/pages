<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fault Tolerance Animation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f8f9fb;
            color: #1a1d29;
            padding: 12px;
            overflow-x: hidden;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #1a1d29;
            font-weight: 700;
            font-size: 24px;
        }

        .instances-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .instance-card {
            background: #ffffff;
            padding: 16px;
            border-radius: 12px;
            border: 2px solid #10b981;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .instance-card.healthy {
            border-color: #10b981;
        }

        .instance-card.failing {
            border-color: #f59e0b;
            animation: warningPulse 1s ease-in-out infinite;
        }

        .instance-card.down {
            border-color: #ef4444;
            opacity: 0.7;
        }

        @keyframes warningPulse {
            0%, 100% { border-color: #f59e0b; }
            50% { border-color: #fbbf24; }
        }

        .instance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .instance-title {
            font-weight: 600;
            font-size: 15px;
            color: #1a1d29;
        }

        .status-indicator {
            padding: 4px 10px;
            border-radius: 9999px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-indicator.healthy {
            background: #d1fae5;
            color: #065f46;
        }

        .status-indicator.failing {
            background: #fef3c7;
            color: #92400e;
        }

        .status-indicator.down {
            background: #fee2e2;
            color: #991b1b;
        }

        .heartbeat-section {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            padding: 8px;
            background: #f3f4f6;
            border-radius: 8px;
        }

        .heartbeat-icon {
            width: 16px;
            height: 16px;
            position: relative;
        }

        .heartbeat-icon.beating::before {
            content: '‚ù§Ô∏è';
            font-size: 16px;
            animation: heartbeat 1s ease-in-out infinite;
        }

        .heartbeat-icon.stopped::before {
            content: 'üíî';
            font-size: 16px;
        }

        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            25% { transform: scale(1.2); }
        }

        .heartbeat-time {
            font-size: 11px;
            color: #6b7280;
            font-family: 'Courier New', monospace;
        }

        .messages-section {
            margin-top: 8px;
        }

        .messages-label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 6px;
            font-weight: 500;
        }

        .messages-container {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            min-height: 40px;
            padding: 8px;
            background: #f3f4f6;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .message-badge {
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: bold;
            border: 2px solid;
            position: relative;
            animation: fadeIn 0.3s ease-out;
        }

        .message-badge.flying {
            animation: flyToQueue 1s ease-out forwards;
            z-index: 100;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        @keyframes flyToQueue {
            0% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
            50% {
                transform: translateY(150px) scale(0.8);
                opacity: 0.5;
            }
            100% {
                transform: translateY(300px) scale(0);
                opacity: 0;
            }
        }

        @keyframes flyToInstance {
            0% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
            50% {
                transform: translateY(-150px) scale(0.8);
                opacity: 0.5;
            }
            100% {
                transform: translateY(-300px) scale(0);
                opacity: 0;
            }
        }

        .message-badge.user-a {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
            color: white;
        }

        .message-badge.user-b {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border-color: #f093fb;
            color: white;
        }

        .message-badge.user-c {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border-color: #4facfe;
            color: white;
        }

        .maintenance-section {
            background: #ffffff;
            padding: 16px;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        .maintenance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .maintenance-title {
            font-weight: 600;
            font-size: 15px;
            color: #1a1d29;
        }

        .last-check {
            font-size: 11px;
            color: #6b7280;
            font-family: 'Courier New', monospace;
        }

        .detection-info {
            display: flex;
            gap: 20px;
            padding: 12px;
            background: #f3f4f6;
            border-radius: 8px;
            font-size: 12px;
        }

        .detection-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .detection-label {
            color: #6b7280;
            font-weight: 500;
        }

        .detection-value {
            color: #1a1d29;
            font-weight: 600;
        }

        .detection-alert {
            margin-top: 8px;
            padding: 10px;
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            border-radius: 6px;
            font-size: 12px;
            color: #92400e;
            animation: slideIn 0.3s ease-out;
        }

        .detection-alert.error {
            background: #fee2e2;
            border-left-color: #ef4444;
            color: #991b1b;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .queue-section {
            background: #ffffff;
            padding: 16px;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        .queue-title {
            font-weight: 600;
            font-size: 15px;
            color: #1a1d29;
            margin-bottom: 12px;
        }

        .queue-container {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            min-height: 60px;
            padding: 12px;
            background: #f3f4f6;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .recovery-log {
            background: #ffffff;
            padding: 16px;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        .recovery-title {
            font-weight: 600;
            font-size: 15px;
            color: #1a1d29;
            margin-bottom: 12px;
        }

        .log-container {
            max-height: 150px;
            overflow-y: auto;
            background: #1a1d29;
            color: #10b981;
            padding: 12px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            line-height: 1.6;
        }

        .log-entry {
            animation: logFadeIn 0.3s ease-out;
        }

        .log-entry.error {
            color: #ef4444;
        }

        .log-entry.warning {
            color: #f59e0b;
        }

        @keyframes logFadeIn {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .controls {
            text-align: center;
            margin-bottom: 12px;
        }

        button {
            background: #4338ca;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 9999px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            margin: 0 6px 6px;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        button:hover:not(:disabled) {
            background: #3730a3;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(67, 56, 202, 0.25);
        }

        button:disabled {
            background: #d1d5db;
            cursor: not-allowed;
            transform: none;
            color: #9ca3af;
        }

        button.danger {
            background: #ef4444;
        }

        button.danger:hover:not(:disabled) {
            background: #dc2626;
            box-shadow: 0 4px 6px rgba(239, 68, 68, 0.25);
        }

        button.warning {
            background: #f59e0b;
        }

        button.warning:hover:not(:disabled) {
            background: #d97706;
            box-shadow: 0 4px 6px rgba(245, 158, 11, 0.25);
        }

        .stats {
            padding: 12px;
            background: #f3f4f6;
            border-radius: 12px;
            text-align: center;
            color: #374151;
            font-weight: 500;
            border: 1px solid #e5e7eb;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Fault Tolerance - Instance Failure & Recovery</h1>

        <div class="instances-section" id="instancesSection"></div>

        <div class="maintenance-section">
            <div class="maintenance-header">
                <span class="maintenance-title">üîç Maintenance Job Monitor</span>
                <span class="last-check" id="lastCheck">Last check: --</span>
            </div>
            <div class="detection-info">
                <div class="detection-item">
                    <span class="detection-label">Healthy Instances</span>
                    <span class="detection-value" id="healthyCount">3</span>
                </div>
                <div class="detection-item">
                    <span class="detection-label">Failed Instances</span>
                    <span class="detection-value" id="failedCount">0</span>
                </div>
            </div>
            <div id="detectionAlert"></div>
        </div>

        <div class="queue-section">
            <h2 class="queue-title">Message Queue/Topic (Reinjection Target)</h2>
            <div class="queue-container" id="queueContainer"></div>
        </div>

        <div class="recovery-log">
            <h2 class="recovery-title">Recovery Log</h2>
            <div class="log-container" id="logContainer">
                <div class="log-entry">[SYSTEM] Monitoring initialized. Checking instance heartbeats...</div>
            </div>
        </div>

        <div class="controls">
            <button onclick="addMessage()">Add Message</button>
            <button onclick="addHealthyInstance()">Add Healthy Instance</button>
            <button onclick="gracefulShutdown()" class="warning" id="gracefulBtn">Graceful Shutdown</button>
            <button onclick="instanceFailure()" class="danger" id="failureBtn">Simulate Instance Failure</button>
            <button onclick="resetAnimation()">Reset</button>
        </div>

        <div class="stats" id="stats">
            Total messages in system: 0 | Messages recovered: 0
        </div>
    </div>

    <script>
        // State management
        const state = {
            instances: [
                { id: 1, status: 'healthy', lastHeartbeat: Date.now(), messages: [] },
                { id: 2, status: 'healthy', lastHeartbeat: Date.now(), messages: [] }
            ],
            queue: [],
            messageCounter: 0,
            recoveredMessages: 0,
            lastMaintenanceCheck: null,
            isProcessing: false,
            nextInstanceId: 3
        };

        const userTypes = ['a', 'b', 'c'];

        function resetAnimation() {
            // Reset state
            state.instances = [
                { id: 1, status: 'healthy', lastHeartbeat: Date.now(), messages: [] },
                { id: 2, status: 'healthy', lastHeartbeat: Date.now(), messages: [] }
            ];
            state.queue = [];
            state.messageCounter = 0;
            state.recoveredMessages = 0;
            state.lastMaintenanceCheck = null;
            state.isProcessing = false;
            state.nextInstanceId = 3;

            // Clear and reset log
            const logContainer = document.getElementById('logContainer');
            logContainer.innerHTML = '<div class="log-entry">[SYSTEM] Animation reset. Monitoring initialized.</div>';

            addLog('[SYSTEM] Checking instance heartbeats...');

            render();

            // Re-initialize with some messages
            setTimeout(initialize, 500);
        }

        function addHealthyInstance() {
            const newInstance = {
                id: state.nextInstanceId,
                status: 'healthy',
                lastHeartbeat: Date.now(),
                messages: []
            };
            state.instances.push(newInstance);
            state.nextInstanceId++;
            addLog(`[SYSTEM] Instance ${newInstance.id} added to cluster`);
            render();

            // If there are messages in the queue, redistribute them
            if (state.queue.length > 0) {
                addLog(`[SYSTEM] Redistributing queued messages to include new Instance ${newInstance.id}`);
                setTimeout(() => {
                    redistributeMessages();
                }, 500);
            }
        }

        function addMessage() {
            const healthyInstances = state.instances.filter(i => i.status === 'healthy');

            if (healthyInstances.length === 0) {
                addLog('[ERROR] No healthy instances available to receive messages', 'error');
                return;
            }

            // Pick a random healthy instance
            const instance = healthyInstances[Math.floor(Math.random() * healthyInstances.length)];

            state.messageCounter++;
            const userType = userTypes[Math.floor(Math.random() * userTypes.length)];
            const messageId = `${userType.toUpperCase()}${state.messageCounter}`;

            instance.messages.push({ id: messageId, user: userType });
            addLog(`[INFO] Message ${messageId} distributed to Instance ${instance.id}`);
            render();
        }

        function heartbeatTick() {
            state.instances.forEach(instance => {
                if (instance.status === 'healthy') {
                    instance.lastHeartbeat = Date.now();
                }
            });
            addLog('[HEARTBEAT] All healthy instances updated heartbeat');
            render();
        }

        function gracefulShutdown() {
            const healthyInstances = state.instances.filter(i => i.status === 'healthy');

            if (healthyInstances.length === 0) {
                addLog('[ERROR] No healthy instances available for shutdown', 'error');
                return;
            }

            // Pick a random healthy instance
            const instance = healthyInstances[Math.floor(Math.random() * healthyInstances.length)];

            addLog(`[WARNING] Instance ${instance.id} initiating graceful shutdown...`, 'warning');
            instance.status = 'failing';
            render();

            // Simulate processing some messages
            setTimeout(() => {
                const messagesToProcess = Math.min(2, instance.messages.length);
                for (let i = 0; i < messagesToProcess; i++) {
                    const msg = instance.messages.shift();
                    if (msg) {
                        addLog(`[INFO] Instance ${instance.id} processed message ${msg.id} before shutdown`);
                    }
                }

                instance.status = 'down';
                addLog(`[WARNING] Instance ${instance.id} shutdown complete. Remaining messages need recovery.`, 'warning');
                render();
            }, 2000);
        }

        function instanceFailure() {
            const healthyInstances = state.instances.filter(i => i.status === 'healthy');

            if (healthyInstances.length === 0) {
                addLog('[ERROR] No healthy instances available for failure simulation', 'error');
                return;
            }

            // Pick a random healthy instance
            const instance = healthyInstances[Math.floor(Math.random() * healthyInstances.length)];

            addLog(`[ERROR] Instance ${instance.id} FAILED - Immediate shutdown detected`, 'error');
            instance.status = 'down';
            render();
        }

        function runMaintenanceCheck() {
            if (state.isProcessing) return;

            state.isProcessing = true;
            state.lastMaintenanceCheck = Date.now();
            addLog('[SYSTEM] Running maintenance check...');
            render();

            setTimeout(() => {
                const now = Date.now();
                const threshold = 30000; // 30 seconds
                let foundFailedInstance = false;

                state.instances.forEach(instance => {
                    const timeSinceHeartbeat = now - instance.lastHeartbeat;

                    if (instance.status === 'down' && instance.messages.length > 0) {
                        foundFailedInstance = true;
                        const messageCount = instance.messages.length;
                        addLog(`[ALERT] Instance ${instance.id} detected as DOWN with ${messageCount} messages`, 'warning');

                        // Animate messages flying to queue
                        setTimeout(() => {
                            const messagesEl = document.querySelector(`[data-instance="${instance.id}"] .messages-container`);
                            if (messagesEl) {
                                const messageBadges = messagesEl.querySelectorAll('.message-badge');
                                messageBadges.forEach((badge, idx) => {
                                    setTimeout(() => {
                                        badge.classList.add('flying');
                                    }, idx * 100);
                                });
                            }
                        }, 100);

                        // After animation, move messages to queue
                        setTimeout(() => {
                            const messages = [...instance.messages];
                            instance.messages = [];

                            messages.forEach(msg => {
                                state.queue.push(msg);
                                state.recoveredMessages++;
                                addLog(`[RECOVERY] Message ${msg.id} reinjected to queue from Instance ${instance.id}`);
                            });

                            render();

                            // Redistribute messages to healthy instances
                            setTimeout(() => {
                                redistributeMessages();
                            }, 800);
                        }, messageCount * 100 + 1200);
                    } else if (instance.status === 'healthy' && timeSinceHeartbeat > threshold) {
                        addLog(`[WARNING] Instance ${instance.id} heartbeat timeout detected`, 'warning');
                    } else if (instance.status === 'healthy') {
                        addLog(`[INFO] Instance ${instance.id} healthy (heartbeat ${Math.floor(timeSinceHeartbeat / 1000)}s ago)`);
                    }
                });

                if (!foundFailedInstance) {
                    state.isProcessing = false;
                    render();
                }
            }, 500);
        }

        function redistributeMessages() {
            if (state.queue.length === 0) {
                state.isProcessing = false;
                return;
            }

            const healthyInstances = state.instances.filter(i => i.status === 'healthy');
            if (healthyInstances.length === 0) {
                addLog('[ERROR] No healthy instances available for redistribution', 'error');
                state.isProcessing = false;
                return;
            }

            addLog(`[SYSTEM] Redistributing ${state.queue.length} messages to ${healthyInstances.length} healthy instances`);

            // Animate messages flying from queue to instances
            const queueEl = document.getElementById('queueContainer');
            const messageBadges = queueEl.querySelectorAll('.message-badge');

            messageBadges.forEach((badge, idx) => {
                setTimeout(() => {
                    badge.style.animation = 'flyToInstance 1s ease-out forwards';
                }, idx * 100);
            });

            // Distribute messages round-robin to healthy instances
            setTimeout(() => {
                const messages = [...state.queue];
                state.queue = [];

                messages.forEach((msg, idx) => {
                    const targetInstance = healthyInstances[idx % healthyInstances.length];
                    targetInstance.messages.push(msg);
                    addLog(`[INFO] Message ${msg.id} redistributed to Instance ${targetInstance.id}`);
                });

                state.isProcessing = false;
                render();
            }, state.queue.length * 100 + 1000);
        }

        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString();
        }

        function render() {
            // Render instances
            const instancesSection = document.getElementById('instancesSection');
            instancesSection.innerHTML = state.instances.map(instance => {
                const timeSinceHeartbeat = Math.floor((Date.now() - instance.lastHeartbeat) / 1000);
                return `
                    <div class="instance-card ${instance.status}" data-instance="${instance.id}">
                        <div class="instance-header">
                            <span class="instance-title">Instance ${instance.id}</span>
                            <span class="status-indicator ${instance.status}">${instance.status}</span>
                        </div>
                        <div class="heartbeat-section">
                            <div class="heartbeat-icon ${instance.status === 'healthy' ? 'beating' : 'stopped'}"></div>
                            <span class="heartbeat-time">${instance.status === 'healthy' ? `${timeSinceHeartbeat}s ago` : 'No heartbeat'}</span>
                        </div>
                        <div class="messages-section">
                            <div class="messages-label">In-Memory Messages (${instance.messages.length})</div>
                            <div class="messages-container">
                                ${instance.messages.map(msg => `
                                    <div class="message-badge user-${msg.user}">${msg.id}</div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Render queue
            const queueContainer = document.getElementById('queueContainer');
            queueContainer.innerHTML = state.queue.map(msg => `
                <div class="message-badge user-${msg.user}">${msg.id}</div>
            `).join('');

            // Update maintenance info
            const healthyCount = state.instances.filter(i => i.status === 'healthy').length;
            const failedCount = state.instances.filter(i => i.status === 'down').length;
            document.getElementById('healthyCount').textContent = healthyCount;
            document.getElementById('failedCount').textContent = failedCount;

            if (state.lastMaintenanceCheck) {
                document.getElementById('lastCheck').textContent = `Last check: ${formatTime(state.lastMaintenanceCheck)}`;
            }

            // Detection alert
            const detectionAlert = document.getElementById('detectionAlert');
            const failedInstances = state.instances.filter(i => i.status === 'down');
            if (failedInstances.length > 0) {
                detectionAlert.innerHTML = failedInstances.map(i =>
                    `<div class="detection-alert error">‚ö†Ô∏è Instance ${i.id} is DOWN - ${i.messages.length} messages pending recovery</div>`
                ).join('');
            } else {
                detectionAlert.innerHTML = '';
            }

            // Update stats
            const totalMessages = state.instances.reduce((sum, i) => sum + i.messages.length, 0) + state.queue.length;
            document.getElementById('stats').textContent =
                `Total messages in system: ${totalMessages} | Messages recovered: ${state.recoveredMessages}`;

            // Update button states
            const hasHealthyInstances = state.instances.some(i => i.status === 'healthy');
            document.getElementById('gracefulBtn').disabled = !hasHealthyInstances;
            document.getElementById('failureBtn').disabled = !hasHealthyInstances;
        }

        // Initialize with some messages
        function initialize() {
            addMessage();
            addMessage();
            addMessage();
            addMessage();
        }

        // Initial render
        render();
        setTimeout(initialize, 500);

        // Auto-heartbeat every 5 seconds
        setInterval(() => {
            heartbeatTick();
        }, 5000);

        // Auto-maintenance check every 10 seconds
        setInterval(() => {
            runMaintenanceCheck();
        }, 10000);
    </script>
</body>
</html>
